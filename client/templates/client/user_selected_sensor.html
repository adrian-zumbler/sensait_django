{% extends 'main_header.html' %}
{% load staticfiles %}

{% block main_content_wrapper %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        {{arduinosensor.arduino.name}} - {{ arduinosensor.sensor_type.name }} - {{ arduinosensor.data_key }}
        <small>Sistema seleccionado</small>
      </h1>
      <ol class="breadcrumb">
        <li>
          <a href="#">
            <i class="fa fa-dashboard"></i>
            Home</a>
        </li>
        <li class="active">Dashboard</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">


      <div class="row">
        <div class="col-md-6">
          <div class="box box-solid">
            <div class="box-header with-border">
              <i class="fa fa-adjust"></i>
              <h3 class="box-title">Información del Sensor</h3>
            </div><!-- /.box-header -->
            <div class="box-body">
              <dl class="dl-horizontal">
                <dt>Proyecto</dt>
                <dd>
                  <a href="/dash/projects/{{arduinosensor.arduino.project.id }}" target="_self">
                    {{arduinosensor.arduino.project.name }}
                  </a>
                </dd>
                <dt>Sistema</dt>
                <dd>
                  <a href="/dash/iot/{{arduinosensor.arduino.id }}" target="_self">
                    {{arduinosensor.arduino.name}}
                  </a>
                </dd>
                <dt>Tipo de Sensor</dt>
                <dd>{{ arduinosensor.sensor_type.name }}</dd>
                <dt># del Sensor en el sistema</dt>
                <dd>{{ arduinosensor.index }}</dd>
                <dt>Valor Maximo</dt>
                <dd>{{ arduinosensor.max_value }}</dd>
                <dt>Valor Minimo</dt>
                <dd>{{ arduinosensor.min_value }}</dd>
              </dl>
            </div><!-- /.box-body -->
          </div><!-- /.box -->
        </div><!-- ./col -->

        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-green">
            <div class="inner">
              <h3 id="ultimoValor">
                {{ arduinosensor.sensor_data.last.data }}
                <sup style="font-size: 20px">°</sup>
              </h3>
              <p>Ultimo valor</p>
            </div>
            <div class="icon">
              <i class="ion ion-stats-bars"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-aqua">
            <div class="inner">
              <h3 id="widget_Promedio">0</h3>
              <p>Promedio <span id="widget_TotalRegistros">(0)</span> registros</p>
            </div>
          </div>
        </div>
        <!-- ./col -->
        <!-- ./col -->
      </div>




      <div class="row">
        <div class="col-xs-12">
          <!-- TABLE: LATEST ORDERS -->
          <div class="box box-info">
            <div class="box-header with-border">
              <h3 class="box-title">
                Grafica del Sensor - {{ arduinosensor.sensor_type.name }} - {{ arduinosensor.data_key }}
              </h3>
              <div class="box-tools pull-right">
                <button class="btn btn-box-tool" data-widget="collapse">
                  <i class="fa fa-minus"></i>
                </button>
                <button class="btn btn-box-tool" data-widget="remove">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <div class="row">

                <div class="col-xs-4 ">
                  <div id="filter_type" class="form-group">
                    <label for="limit_selector" class=" col-xs-12 control-label">Tipo de Filtrado:</label>
                    <div class="col-xs-8">
                      <select class="form-control" id="type_selector">
                        <option value="0">Seleccione una opcion</option>
                        <option value="1">No. de Registros</option>
                        <option value="2">Rango de Tiempo</option>
                        <option value="3">Rango de Tiempo y No. de Registros</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="col-xs-4 ">
                  <div id="filter_date" class="form-group">
                    <label for="date_selector" class=" control-label">Seleccione fechas:</label>
                    <div class="">
                      <button type="button" class="btn btn-default pull-left" id="daterange"><span><i class="fa fa-calendar"></i> Selección de Fechas</span><i class="fa fa-caret-down"></i></button>
                    </div>
                  </div>
                </div>

                <div class="col-xs-4 ">
                  <div id="filter_limit" class="form-group">
                    <label for="limit_selector" class=" col-xs-12 control-label">Ultimos Registros</label>
                    <div class="col-xs-6">
                      <select class="form-control" id="limit_selector">
                        <option>1000</option>
                        <option>750</option>
                        <option>500</option>
                        <option>400</option>
                        <option>300</option>
                        <option>250</option>
                        <option>200</option>
                        <option>100</option>
                        <option>50</option>
                        <option>Otra</option>
                        <option>Todos</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="col-xs-12 ">
                  <br/>
                  La siguiente grafica corresponde a: <b><span id="filter_resume"></span></b>
                  <br/><br/>
                </div>
                <br/><br/><br/><br/>
              </div>

              <div id="graphdiv"></div>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
      </div>

    <div class="row">

      <div class="col-md-6">
        <div class="box">
          <div class="box-header with-border">
            <h3 class="box-title">Registros del Sensor</h3>
          </div><!-- /.box-header -->
          <div class="box-body">
            <table id="table_allData" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th> ID </th>
                  <th>Fecha </th>
                  <th>Valor</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>

              {% for data in arduinosensor.sensor_data.all %}
                <tr>
                  <td>{{ data.id  }}</td>
                  <td>{{ data.created_at }}</td>
                  <td>{{ data.data }}</td>
                  <td> <span class="badge bg-green">En rango</span> </td>
                </tr>
              {% endfor %}

              </tbody>
            </table>
          </div><!-- /.box-body -->
        </div><!-- /.box -->

      </div><!-- /.col -->

      <div class="col-md-6">
        <div class="box box-solid">
          <div class="box-header with-border">
            <i class="fa fa-adjust"></i>
            <h3 class="box-title">Resumen de registros</h3>
          </div><!-- /.box-header -->
          <div class="box-body">
            <dl class="dl-horizontal">
              <dt>Registros taotales</dt>
              <dd id="totalRegistros">0</dd>
              <dt>Registros con riesgo</dt>
              <dd id="totalConRiesgo">0</dd>
              <dt>Alertas Enviadas</dt>
              <dd id="totalAlertas">0</dd>
              <dt>Promedio</dt>
              <dd id="totalPromedio">0</dd>
              <dt>Valor minimo</dt>
              <dd id="valorMinimo">0</dd>
              <dt>Valor maximo</dt>
              <dd id="valorMaximo">0</dd>
            </dl>
          </div><!-- /.box-body -->
        </div><!-- /.box -->
      </div><!-- ./col -->

    </div><!-- /.row -->





    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

{% endblock main_content_wrapper %}

{% block content_js %}

  <script src="{% static 'plugins/dygraphs/dygraph-combined.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/ws4redis.js' %}"></script>
  <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'plugins/datatables/dataTables.bootstrap.min.js' %}"></script>


  <script type="application/javascript">
    // Validamos el entorno donde estamos trabajando
    //Tambien tomamos la IP dinamica para ya no moverle :3
    //##############################
    var pageUrl = window.location.href;
    pageUrl = pageUrl.split('//');
    pageUrl[1] = pageUrl[1].split('.');

    var urlApi;
    var tokenCode ;
    var userIP;
    var userPort = "8000";

    if(pageUrl[1][0] == 'sensait'){
      urlApi = 'http://sensait.dyndns.org:'+userPort+'/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/'
      tokenCode = 'Token d7e7f378cdc67dcd7cec11b76e017927c3e73bc3';
    }
    else{
      var removePort = pageUrl[1][3];
      removePort  = removePort.split(":");
      //removePort  = removePort.replace(":8000/dash/main/","")

      userIP      = pageUrl[1][0]+'.'+pageUrl[1][1]+'.'+pageUrl[1][2]+'.'+removePort[0]
      tokenCode   = 'Token 6b4f2e70ae0d435bf512897355947fe0a564972a';

      //Para cuando se accede desde la RED local el server
      if( userIP == "192.168.253.31"){
        tokenCode = 'Token d7e7f378cdc67dcd7cec11b76e017927c3e73bc3';
        userPort = "80";
      }

      urlApi  = 'http://' + userIP +':'+userPort+'/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/';

    }
    //##############################

  var canUseSocket = false;
  var ws4redis = WS4Redis({
    uri: 'ws://'+userIP+':'+userPort+'/ws/{{arduinosensor.arduino.arduino_token}}?subscribe-broadcast&publish-broadcast&echo',
    //'ws://sensait.dyndns.org/ws/{{arduinosensor.arduino.arduino_token}}?subscribe-broadcast&publish-broadcast&echo',
    connecting: on_connecting,
    connected: on_connected,
    receive_message: receiveMessage,
    disconnected: on_disconnected,
    heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
  });

  // attach this function to an event handler on your site
  function sendMessage() {
    ws4redis.send_message('A message');
  }

  function on_connecting() {
    alert('Websocket is connecting...');
  }

  function on_connected() {
    ws4redis.send_message('Hello');
  }

  function on_disconnected(evt) {
    alert('Websocket was disconnected: ' + JSON.stringify(evt));
  }

  // receive a message though the websocket from the server
  function receiveMessage(msg) {
    useWSData(msg);
  }

//##############################

function useWSData(data){

  if(canUseSocket == true ){

      var jso = JSON.parse(data);
      //console.log(jso);
      console.log('Message from Websocket: ' + data);
      console.log(jso.length);

      console.log(date_today);
      console.log();

      if( moment(date_today).isBetween(filter_date_start, filter_date_end ) || moment(date_today).isSameOrBefore(filter_date_end )){

        for(var i= 0 ; i < jso.length ; i++){

          console.log(jso[i]['data']);
          if(jso[i]['arduino_sensor'] == {{arduinosensor.id}}){

            sensor_data_chart.push(jso[i]['data']);

            var d = new Date(jso[i]['created_at']);
            var d_days = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
            var d_time = completeTimeFormat(d.getHours(), d.getMinutes(), d.getSeconds());
            sensor_date_chart.push(d_time);
            var lastPosition = _sensors_data.length;

            $('#totalRegistros').html(lastPosition);

            _sensors_data.push(jso[i]);
            console.log(_sensors_data);
            console.log(lastPosition);
             //_sensors_data[lastPosition]['data'] = jso[i]['data'];

            dygraphs_data.push([d, _sensors_data[lastPosition]['data'], {{ arduinosensor.min_value }}, {{ arduinosensor.max_value }}]);

            g.destroy();

            g = new Dygraph(document.getElementById("graphdiv"), dygraphs_data, {
              drawPoints: true,
              showRoller: true,
              height: 400,
              highlightSeriesBackgroundAlpha: 0.8,
              fillGraph: true,
              includeZero: false,
              strokeWidth: 3,
              labels: ['Tiempo', 'Temperatura', 'Min', 'Max']
            });


          }else{
            console.log("ño");
          }
        }
      }
  }else{
    console.log("Esperaaaa....");
  }
}




  //var urlApi = 'http://sensait.dyndns.org/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/';
  //var urlApi = 'http://dashboard:8000/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/';

  var _arduino;
  var _sensors;
  var _sensors_data;
  var tableNameID = '#table_allData';
  var allData;

  var g ; // variable de la grafica

  var promedio=0,
      media=0,
      valorMaximo=0,
      valorMinimo=0,
      totalRegistros=0,
      totalAlertas=0,
      totalRiesgo=0;


  var query_startDate   = "";
  var query_endDate     = "";
  var query_dataLimit   = "1000";
  var filter_type       = 0 ;
  var filter_registers  = query_dataLimit ;
  var filter_date_start = "" ;
  var filter_date_end   = "" ;
  var date_today;

    $(document).ready(function(){

      //ocultamos los selectores de la grafica
      $("#filter_date").hide();
      $("#filter_limit").hide();
       date_today = moment().format("YYYY-MM-DD");
      //primera petición de datos.
      allData = getDataFromAPI("","",query_dataLimit);

      $("#filter_resume").html("Ultimos " + query_dataLimit + " registros" );
    });



    $(tableNameID).DataTable({
      "paging": true,
      "lengthChange": false,
      "searching": true,
      "ordering": true,
      "info": true,
      "autoWidth": false,
      "pageLength": 5
    });

    $('#limit_selector').on('change', function() {
      var limit = this.value;
      filter_registers = limit;

      if(filter_type == 1 ){
        $("#filter_resume").html("Ultimos " + limit + " registros." );
        getDataFromAPI("","", filter_registers);
      }
      else {
        $("#filter_resume").html("Fecha del  " + filter_date_start + " al " + filter_date_end + " como maximo "+ limit + " registros" );
        getDataFromAPI(filter_date_start,filter_date_end, filter_registers);
      }
    });

    //moment.locale('es');
    //moment("12/25/1995", "MM-DD-YYYY");
    $('#daterange').daterangepicker({
      locale: {
       format: "YYYY-MM-DD",
       "separator": " - ",
       applyLabel: "Aplicar",
       cancelLabel: "Cancelar",
       fromLabel: "Del",
       toLabel: "Al",
       daysOfWeek: [
            "Dom",
            "Lun",
            "Mar",
            "Mie",
            "Jue",
            "Vie",
            "Sab"
        ],
        monthNames: [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre"
        ],
     },
     opens: "center",
     drops: "up",
     showWeekNumbers:true,
     minDate: moment().subtract(40, 'days'), //moment(min_date,"YYYY-MM-DD"),
     maxDate: moment().add(1,'days'),
     startDate: moment(), //moment(min_date,"YYYY-MM-DD"),
     endDate: moment() //moment(max_date,"YYYY-MM-DD")
    },
    function (start, end) {
      console.log(start);
      filter_date_start = start.format('YYYY-MM-DD');
      filter_date_end   = end.format('YYYY-MM-DD');

      if(filter_type == 2 )
        $("#filter_resume").html("Fecha del  " + filter_date_start + " al " + filter_date_end  );
      else {
        $("#filter_resume").html("Fecha del  " + filter_date_start + " al " + filter_date_end + " como maximo "+ filter_registers + " registros" );
      }

      getDataFromAPI(filter_date_start,filter_date_end, filter_registers);

    });

    $('#type_selector').on('change', function() {
      var type = this.value;
      filter_type = type;

      //Tipos:
      //0   Titulo
      //"1" No de Registros
      //"2" Rango de Fechas
      //"3" Rango de Fechas y No. de Registros
      if(type != 0 ){
        if(type == 1){
          $("#filter_date").hide();
          $("#filter_limit").show();
          $("#filter_resume").html("Ultimos " + filter_registers + " registros." );
          getDataFromAPI("","", filter_registers);
        }else if (type == 2) {
          $("#filter_date").show();
          $("#filter_limit").hide();
        }else if (type == 3) {
          $("#filter_date").show();
          $("#filter_limit").show();
        }
      }
      console.log(type);

      //getDataFromAPI("","",this.value);
    });





    function getDataFromAPI(query_startDate, query_endDate, query_dataLimit){


      var query =  "?";

      if(query_startDate != "")
        query += "min_time=" + query_startDate + " 00:00:00";

      if(query_endDate != "")
        query += "&max_time=" + query_endDate + " 00:00:00";

      if(query_dataLimit != "" && query_endDate == "")
        query += "last=" + query_dataLimit;

      if(query_dataLimit != "" && query_endDate != "")
        query += "&last=" + query_dataLimit;

        console.log(query);
      $.ajax({
        url: urlApi + query ,
        type: 'GET',
        contentType: 'json/application',
        dataType: 'json',
        processData: false,
        xhrFields: {
          withCredentials: false
        },
        headers: {
          'Authorization': tokenCode
        },
        success: function(data) {
          //console.log('AJAX API SUCCESS!');
          console.log();
          if(data.length > 0){
            dataCallBack(data);
          }
          else{
            if(g != null ){
              g.destroy();
              g = null;
            }
            $('#graphdiv').html("Lo sentimos, no se encontraron registros con ese filtro aplicado, favor de especificar otro. ");

          }

        },
        error: function() {
          console.log('boo!');
        }
      });
    }

    function dataCallBack(data){
      totalRegistros = data.length;

      var tmpPromedio=0;
      var tmpValue=0;

      for(var i=0; i < data.length ; i++){
        tmpValue = parseInt(data[i]['data']);
        tmpPromedio += tmpValue;

        if(i == 0){
          valorMinimo = tmpValue;
          valorMaximo = tmpValue;
        }

        if( tmpValue < valorMinimo   )
          valorMinimo = tmpValue;

        if( tmpValue > valorMaximo )
          valorMaximo = tmpValue;
      }

      promedio = tmpPromedio/totalRegistros;

      //Escribimos los valores en el html
      $('#totalRegistros').html(totalRegistros);
      $('#totalConRiesgo').html('000');
      $('#totalAlertas').html('000');
      $('#totalPromedio').html(promedio.toFixed(2));
      $('#valorMinimo').html(valorMinimo);
      $('#valorMaximo').html(valorMaximo);

      $('#widget_Promedio').html(promedio.toFixed(2));
      $('#widget_TotalRegistros').html(totalRegistros);

      createGraph(data);
    }


    var sensor_data_chart = [];
    var sensor_date_chart = [];
    var dygraphs_data = [];

  function createGraph(data) {
    _sensors_data = null;
    sensor_data_chart = [];
    sensor_date_chart = [];
    dygraphs_data =  [];

    _sensors_data = data;

    for (var i = 0; i < _sensors_data.length; i++) {
      sensor_data_chart.push(_sensors_data[i]['data']);

      var d = new Date(_sensors_data[i]['created_at']);
      var d_days = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
      var d_time = completeTimeFormat(d.getHours(), d.getMinutes(), d.getSeconds());
      sensor_date_chart.push(d_time);

      dygraphs_data.push([d, _sensors_data[i]['data'], {{ arduinosensor.min_value }}, {{ arduinosensor.max_value }}]);

    }

    if(g != null ){
      g.destroy();
      g = null;
      $('#graphdiv').html('');
    }



    g = new Dygraph(document.getElementById("graphdiv"), dygraphs_data, {
      drawPoints: true,
      showRoller: true,
      height: 400,
      highlightSeriesBackgroundAlpha: 0.8,
      fillGraph: true,
      includeZero: false,
      strokeWidth: 3,
      labels: ['Tiempo', 'Temperatura', 'Min', 'Max']
    });

    canUseSocket = true;

  }

  function completeTimeFormat(hours, minutes, seconds) {
    if (hours < 10) {
      hours = "0" + hours;
    }
    if (minutes < 10) {
      minutes = "0" + minutes;
    }
    if (seconds < 10) {
      seconds = "0" + seconds;
    }
    return hours + ':' + minutes + ':' + seconds;
  }

  </script>
{% endblock content_js %}
