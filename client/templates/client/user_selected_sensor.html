{% extends 'main_header.html' %}
{% load staticfiles %}

{% block main_content_wrapper %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        {{arduinosensor.arduino.name}} - {{ arduinosensor.sensor_type.name }} - {{ arduinosensor.data_key }}
        <small>Sistema seleccionado</small>
      </h1>
      <ol class="breadcrumb">
        <li>
          <a href="#">
            <i class="fa fa-dashboard"></i>
            Home</a>
        </li>
        <li class="active">Dashboard</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">


      <div class="row">
        <div class="col-md-6">
          <div class="box box-solid">
            <div class="box-header with-border">
              <i class="fa fa-adjust"></i>
              <h3 class="box-title">Información del Sensor</h3>
            </div><!-- /.box-header -->
            <div class="box-body">
              <dl class="dl-horizontal">
                <dt>Proyecto</dt>
                <dd>
                  <a href="/dash/projects/{{arduinosensor.arduino.project.id }}" target="_self">
                    {{arduinosensor.arduino.project.name }}
                  </a>
                </dd>
                <dt>Sistema</dt>
                <dd>
                  <a href="/dash/iot/{{arduinosensor.arduino.id }}" target="_self">
                    {{arduinosensor.arduino.name}}
                  </a>
                </dd>
                <dt>Tipo de Sensor</dt>
                <dd>{{ arduinosensor.sensor_type.name }}</dd>
                <dt># del Sensor en el sistema</dt>
                <dd>{{ arduinosensor.index }}</dd>
                <dt>Valor Maximo</dt>
                <dd>{{ arduinosensor.max_value }}</dd>
                <dt>Valor Minimo</dt>
                <dd>{{ arduinosensor.min_value }}</dd>
              </dl>
            </div><!-- /.box-body -->
          </div><!-- /.box -->
        </div><!-- ./col -->

        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-green">
            <div class="inner">
              <h3 id="ultimoValor">
                {{ arduinosensor.sensor_data.last.data }}
                <sup style="font-size: 20px">°</sup>
              </h3>
              <p>Ultimo valor</p>
            </div>
            <div class="icon">
              <i class="ion ion-stats-bars"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-xs-6">
          <!-- small box -->
          <div class="small-box bg-aqua">
            <div class="inner">
              <h3 id="widget_Promedio">0</h3>
              <p>Promedio <span id="widget_TotalRegistros">(0)</span> registros</p>
            </div>
          </div>
        </div>
        <!-- ./col -->
        <!-- ./col -->
      </div>




      <div class="row">
        <div class="col-xs-12">
          <!-- TABLE: LATEST ORDERS -->
          <div class="box box-info">
            <div class="box-header with-border">
              <h3 class="box-title">
                Grafica del Sensor - {{ arduinosensor.sensor_type.name }} - {{ arduinosensor.data_key }}
              </h3>
              <div class="box-tools pull-right">
                <button class="btn btn-box-tool" data-widget="collapse">
                  <i class="fa fa-minus"></i>
                </button>
                <button class="btn btn-box-tool" data-widget="remove">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
            <!-- /.box-header -->
            <div class="box-body"></div>
            <!-- /.box-body -->
            <div id="graphdiv"></div>
            <div class="box-footer clearfix">
              <a href="javascript::;" class="btn btn-sm btn-default btn-flat pull-right">

              </a>
            </div>
            <!-- /.box-footer -->
          </div>
          <!-- /.box -->
        </div>
      </div>

    <div class="row">

      <div class="col-md-6">
        <div class="box">
          <div class="box-header with-border">
            <h3 class="box-title">Registros del Sensor</h3>
          </div><!-- /.box-header -->
          <div class="box-body">
            <table id="table_allData" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th> ID </th>
                  <th>Fecha </th>
                  <th>Valor</th>
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody>

              {% for data in arduinosensor.sensor_data.all %}
                <tr>
                  <td>{{ data.id  }}</td>
                  <td>{{ data.created_at }}</td>
                  <td>{{ data.data }}</td>
                  <td> <span class="badge bg-green">En rango</span> </td>
                </tr>
              {% endfor %}

              </tbody>
            </table>
          </div><!-- /.box-body -->
        </div><!-- /.box -->

      </div><!-- /.col -->

      <div class="col-md-6">
        <div class="box box-solid">
          <div class="box-header with-border">
            <i class="fa fa-adjust"></i>
            <h3 class="box-title">Resumen de registros</h3>
          </div><!-- /.box-header -->
          <div class="box-body">
            <dl class="dl-horizontal">
              <dt>Registros taotales</dt>
              <dd id="totalRegistros">0</dd>
              <dt>Registros con riesgo</dt>
              <dd id="totalConRiesgo">0</dd>
              <dt>Alertas Enviadas</dt>
              <dd id="totalAlertas">0</dd>
              <dt>Promedio</dt>
              <dd id="totalPromedio">0</dd>
              <dt>Valor minimo</dt>
              <dd id="valorMinimo">0</dd>
              <dt>Valor maximo</dt>
              <dd id="valorMaximo">0</dd>
            </dl>
          </div><!-- /.box-body -->
        </div><!-- /.box -->
      </div><!-- ./col -->

    </div><!-- /.row -->





    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

{% endblock main_content_wrapper %}

{% block content_js %}

  <script src="{% static 'plugins/dygraphs/dygraph-combined.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/ws4redis.js' %}"></script>
  <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'plugins/datatables/dataTables.bootstrap.min.js' %}"></script>


  <script type="application/javascript">




    // Validamos el entorno donde estamos trabajando
    //Tambien tomamos la IP dinamica para ya no moverle :3
    //##############################
    var pageUrl = window.location.href;
    pageUrl = pageUrl.split('//');
    pageUrl[1] = pageUrl[1].split('.');


    var urlApi;
    var tokenCode ;
    var userIP;

    if(pageUrl[1][0] == 'sensait'){
      urlApi = 'http://sensait.dyndns.org:8000/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/'
      tokenCode = 'Token d7e7f378cdc67dcd7cec11b76e017927c3e73bc3';
    }
    else{
      var removePort = pageUrl[1][3];
      removePort  = removePort.replace(":8000/dash/main/","")
      userIP      = pageUrl[1][0]+'.'+pageUrl[1][1]+'.'+pageUrl[1][2]+'.'+removePort
      urlApi  = 'http://' + userIP +':8000/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/';
      tokenCode   = 'Token 6b4f2e70ae0d435bf512897355947fe0a564972a';
    }

      //var urlApi = 'http://dashboard:8000/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/';



    //##############################





  var canUseSocket = false;
  var ws4redis = WS4Redis({
    uri: 'ws://'+userIP+':8000/ws/{{arduinosensor.arduino.arduino_token}}?subscribe-broadcast&publish-broadcast&echo',

    //'ws://sensait.dyndns.org/ws/{{arduinosensor.arduino.arduino_token}}?subscribe-broadcast&publish-broadcast&echo',
    connecting: on_connecting,
    connected: on_connected,
    receive_message: receiveMessage,
    disconnected: on_disconnected,
    heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
  });

  // attach this function to an event handler on your site
  function sendMessage() {
    ws4redis.send_message('A message');
  }

  function on_connecting() {
    alert('Websocket is connecting...');
  }

  function on_connected() {
    ws4redis.send_message('Hello');
  }

  function on_disconnected(evt) {
    alert('Websocket was disconnected: ' + JSON.stringify(evt));
  }

  // receive a message though the websocket from the server
  function receiveMessage(msg) {
    useWSData(msg);
  }



function useWSData(data){

      if(canUseSocket == true ){
        var jso = JSON.parse(data);
        //console.log(jso);
        console.log('Message from Websocket: ' + data);
        console.log(jso.length);

        for(var i= 0 ; i < jso.length ; i++){
          console.log(jso[i]['data']);


          if(jso[i]['arduino_sensor'] == {{arduinosensor.id}}  ){

            console.log("Chi");
            sensor_data_chart.push(jso[i]['data']);

            var d = new Date(jso[i]['created_at']);
            var d_days = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
            var d_time = completeTimeFormat(d.getHours(), d.getMinutes(), d.getSeconds());
            sensor_date_chart.push(d_time);
            var lastPosition = _sensors_data.length;

            $('#totalRegistros').html(lastPosition);

            _sensors_data.push(jso[i]);
            console.log(_sensors_data);
            console.log(lastPosition);
             //_sensors_data[lastPosition]['data'] = jso[i]['data'];

            dygraphs_data.push([d, _sensors_data[lastPosition]['data'], "10", "50"]);

            console.log("______");
            console.log(g);
            console.log("______");

            g.destroy();

            g = new Dygraph(document.getElementById("graphdiv"), dygraphs_data, {
              drawPoints: true,
              showRoller: true,
              valueRange: [
                0, 150
              ],
              height: 400,
              //width: 100%,
              highlightSeriesBackgroundAlpha: 0.8,
              fillGraph: true,
              includeZero: true,
              strokeWidth: 3,
              //showRangeSelector: true,
              labels: ['Tiempo', 'Temperatura', 'Min', 'Max']
            });


          }else{
            console.log("ño");
          }
      }
    }else{
      console.log("Esperaaaa....");
    }

}



  var tableNameID = '#table_allData';
  var allData;

  var g ;

  //var urlApi = 'http://sensait.dyndns.org/api/arduinos/{{ arduinosensor.arduino.id }}/sensors/{{ arduinosensor.id }}/data/';

  var _arduino;
  var _sensors;
  var _sensors_data;

  var promedio=0,
      media=0,
      valorMaximo=0,
      valorMinimo=0,
      totalRegistros=0,
      totalAlertas=0,
      totalRiesgo=0;

    $(document).ready(function(){
      //console.log(urlApi);
      allData = getDataFromAPI();
    });

    $(tableNameID).DataTable({
      "paging": true,
      "lengthChange": false,
      "searching": true,
      "ordering": true,
      "info": true,
      "autoWidth": false,
      "pageLength": 5
    });


    function getDataFromAPI(){
      //Peticion AJAX de los datos
      $.ajax({
        url: urlApi,
        type: 'GET',
        contentType: 'json/application',
        dataType: 'json',
        processData: false,
        xhrFields: {
          withCredentials: false
        },
        headers: {
          'Authorization': tokenCode
        },
        success: function(data) {
          console.log('AJAX API SUCCESS!');
          //Se hara un return con el JSON obtenido en la API
          //console.log(data);
          dataCallBack(data);
        },
        error: function() {
          console.log('boo!');
        }
      });
    }

    function dataCallBack(data){
      totalRegistros = data.length;

      var tmpPromedio=0;
      var tmpValue=0;

      for(var i=0; i < data.length ; i++){
        tmpValue = parseInt(data[i]['data']);
        tmpPromedio += tmpValue;

        if(i == 0){
          valorMinimo = tmpValue;
          valorMaximo = tmpValue;
        }

        if( tmpValue < valorMinimo   )
          valorMinimo = tmpValue;

        if( tmpValue > valorMaximo )
          valorMaximo = tmpValue;
      }

      promedio = tmpPromedio/totalRegistros;

      //Escribimos los valores en el html
      $('#totalRegistros').html(totalRegistros);
      $('#totalConRiesgo').html('000');
      $('#totalAlertas').html('000');
      $('#totalPromedio').html(promedio.toFixed(2));
      $('#valorMinimo').html(valorMinimo);
      $('#valorMaximo').html(valorMaximo);

      $('#widget_Promedio').html(promedio.toFixed(2));
      $('#widget_TotalRegistros').html(totalRegistros);

      createGraph(data);
    }


    var sensor_data_chart = [];
    var sensor_date_chart = [];
    var dygraphs_data = [];

  function createGraph(data) {
    _sensors_data = data;

    for (var i = 0; i < _sensors_data.length; i++) {
      sensor_data_chart.push(_sensors_data[i]['data']);

      var d = new Date(_sensors_data[i]['created_at']);
      var d_days = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
      var d_time = completeTimeFormat(d.getHours(), d.getMinutes(), d.getSeconds());
      sensor_date_chart.push(d_time);

      dygraphs_data.push([d, _sensors_data[i]['data'], "10", "50"]);

    }

    /*
    console.log("LABELS");
    console.log(sensor_date_chart);

    console.log("SERIES");
    console.log(sensor_data_chart);

    console.log("a verssss");
    console.log(dygraphs_data);
    */
    g = new Dygraph(document.getElementById("graphdiv"), dygraphs_data, {
      drawPoints: true,
      showRoller: true,
      valueRange: [
        0, 100
      ],
      height: 400,
      //width: 100%,
      highlightSeriesBackgroundAlpha: 0.8,
      fillGraph: true,
      includeZero: true,
      strokeWidth: 3,
      //showRangeSelector: true,
      labels: ['Tiempo', 'Temperatura', 'Min', 'Max']
    });

    canUseSocket = true;

  }

  function completeTimeFormat(hours, minutes, seconds) {
    if (hours < 10) {
      hours = "0" + hours;
    }
    if (minutes < 10) {
      minutes = "0" + minutes;
    }
    if (seconds < 10) {
      seconds = "0" + seconds;
    }
    return hours + ':' + minutes + ':' + seconds;
  }

  </script>
{% endblock content_js %}




{% block ws %}
  //uri: 'ws://192.168.15.17:8000/ws/foobar?subscribe-broadcast&publish-broadcast&echo',
    var ws4redis = WS4Redis({
      uri: 'ws://192.168.15.17:8000/ws/foobar?subscribe-broadcast&publish-broadcast&echo',
      connecting: on_connecting,
      connected: on_connected,
      receive_message: receiveMessage,
      disconnected: on_disconnected,
      heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
    });

    // attach this function to an event handler on your site
    function sendMessage() {
      ws4redis.send_message('A message');
    }

    function on_connecting() {
      alert('Websocket is connecting...');
    }

    function on_connected() {
      ws4redis.send_message('Hello');
    }

    function on_disconnected(evt) {
      alert('Websocket was disconnected: ' + JSON.stringify(evt));
    }

    // receive a message though the websocket from the server
    function receiveMessage(msg) {
      var jso = JSON.parse(msg);
      //console.log(jso);
      console.log('Message from Websocket: ' + msg);

    }
{% endblock ws %}
