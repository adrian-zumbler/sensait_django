{% extends 'main_header.html' %}
{% load staticfiles %}

{% load arduino_tags %}

{% block main_content_wrapper %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        DASHBOARD PRINCIPAL
        <small>Control panel</small>
      </h1>
      <ol class="breadcrumb">
        <li>
          <a href="#">
            <i class="fa fa-dashboard"></i>
            Home</a>
        </li>
        <li class="active">Dashboard</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">

      <div class="row">

        <div class="col-md-8">
          <!-- TABLE: LATEST ORDERS -->
          <div class="box box-info">
            <div class="box-header with-border">
              <h3 class="box-title">
                PROYECTOS ACTIVOS
              </h3>
              <div class="box-tools pull-right">
                <button class="btn btn-box-tool" data-widget="collapse">
                  <i class="fa fa-minus"></i>
                </button>
                <button class="btn btn-box-tool" data-widget="remove">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
            <!-- /.box-header -->

            <div class="box-body">
              <div id ="my_projects" class="table">
                <table id="table_projects"  class="table no-margin">
                  <thead>
                    <tr>
                      <th>ID Proyecto</th>
                      <th>Nombre</th>
                      <th>No. de IoTs</th>
                      <th>Estatus</th>
                      <th>Accion</th>
                    </tr>
                  </thead>
                  <tbody>

                    {% for project in project_list %}
                    <tr id="proy_{{project.id}}" >
                      <td>
                        PROY00{{project.id}}
                      </td>
                      <td>
                        {{project.name}}
                      </td>
                      <td>{{project.arduinos.count}}</td>
                      <td>
                        <span class="label label-success">Correcto</span>
                        {% comment %}
                          {% for arduino in project.arduinos.all %}
                            {{ arduino.id }} ,
                            {% for sensor in arduino.arduino_sensors.all %}
                                {{ sensor.description }} ,
                            {% endfor %}
                          {% endfor %}
                        {% endcomment %}
                      </td>
                      <td>
                        {%if forloop.counter0	== 0 %}
                        <button  id="activar_{{project.id}}" type="button" class="btn btn-info">Activo</button>
                        {% else %}
                        <button  id="activar_{{project.id}}" type="button" class="btn btn-default">Seleccionar</button>
                        {% endif%}
                      </td>
                    </tr>
                    {% endfor %}

                  </tbody>
                </table>
              </div>
              <!-- /.table-responsive      <span class="label label-success">Activo</span>  -->
            </div>


            <!-- /.box-body -->
            <!-- /.box-footer -->
          </div>
          <!-- /.box -->
        </div>

        <div class="col-md-4">
          <div class="box box-info">
            <div class="box-header with-border">
              <h3 class="box-title">
                <b> {{project_list.first.name}}   </b>
                 - Sistemas Activos
              </h3>
              <div class="box-tools pull-right">
                <button class="btn btn-box-tool" data-widget="collapse">
                  <i class="fa fa-minus"></i>
                </button>
                <button class="btn btn-box-tool" data-widget="remove">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
            <!-- /.box-header -->

            <div class="box-body">
              <div id ="my_sistemas" class="table">
                <table id="table_sistemas"  class="table no-margin">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Accion</th>
                    </tr>
                  </thead>
                  <tbody id="my_arduinos">

                  </tbody>
                  </table>
                </div>

            <!-- /.box-body -->
            <!-- /.box-footer -->
            </div>
          </div>
        </div>


        <div class="col-md-12">
          <!-- TABLE: LATEST ORDERS -->
          <div class="box box-info">
            <div class="box-header with-border">
              <h3 class="box-title">
                SENSORES DEL PROYECTO SELECCIONADO
              </h3>
            </div>
            <div class="box-body">
              <div class="nav-tabs-custom">
              <ul class="nav nav-tabs">

                    {% for arduino in project_list.first.arduinos.all %}
                      {% for sensor in arduino.arduino_sensors.all %}

                      {% if forloop.counter0 == 0 %}
                        <li class="active"><a href="#tab_{{sensor.id}}" data-toggle="tab">
                          {{sensor.description }}
                        </a></li>
                      {% else %}
                        <li><a href="#tab_{{sensor.id}}" data-toggle="tab">
                          {{sensor.description }}
                        </a></li>
                      {% endif %}

                      {% endfor %}
                    {% endfor %}
              </ul>

              <div class="tab-content">

                  {% for arduino in project_list.first.arduinos.all %}
                      {% for sensor in arduino.arduino_sensors.all %}

                      {% if forloop.counter0 == 0 %}
                        <div class="tab-pane active" id="tab_{{sensor.id}}"></div>
                      {% else %}
                        <div class="tab-pane" id="tab_{{sensor.id}}"></div>
                      {% endif %}

                      {% endfor %}
                    {% endfor %}
                <!-- /.tab-pane -->
              </div>
              <!-- /.tab-content -->
            </div>
            </div>
          </div>
      </div>




    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

{% endblock main_content_wrapper %}


{% block content_js %}
  <script src="{% static 'plugins/dygraphs/dygraph-combined.js' %}"></script>
  <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'plugins/datatables/dataTables.bootstrap.min.js' %}"></script>
  <!-- page script -->

  <script type="application/javascript">

  $('#table_projects').DataTable({
    "paging": true,
    "lengthChange": false,
    "searching": false,
    "ordering": true,
    "info":true,
  });


  $('#table_sistemas').DataTable({
    "paging": true,
    "lengthChange": false,
    "searching": false,
    "ordering": true,
    "info":true,
  });




  var tokenCode = 'Token d7e7f378cdc67dcd7cec11b76e017927c3e73bc3';
  var allData;
  var urlApiBase  = 'http://dashboard:8000/api/';


  var actualProject = ' ' ;
  var actualArduino = ' ' ;
  var projectsApi   = 'projects/{{ project_list.first.arduinos.first.id }}/';
  var arduinosApi   = 'arduinos/';
  var sensorsApi    = 'sensors/idsensor/data/';

  var _sensors_data;
  var g;  //variable para crear la grafica.
  //sensors/{{ arduinosensor.id }}/data/

  $(document).ready(function(){
    //console.log("HOLO");
    actualProject = {{ project_list.first.id }} ;
    actualArduino = {{ project_list.first.arduinos.first.id }};

    getArduinosFromAPI( actualProject );
  });

  $("[id^=proy_]").click(function(){
    //console.log( $(this)[0].id );
    var project_selected_ID =  $(this)[0].id;
    project_selected_ID     = project_selected_ID.replace("proy_","");
    //console.log( project_selected_ID );
    //console.log( urlApiBase + arduinosApi  );
    getArduinosFromAPI(project_selected_ID);
  });


  function getArduinosFromAPI(arduino_ID){
    //Peticion AJAX de los datos
    //console.log(urlApiBase + arduinosApi + actualArduino + '/');

    $.ajax({
      url: urlApiBase + arduinosApi + actualArduino + '/',
      type: 'GET',
      contentType: 'json/application',
      dataType: 'json',
      processData: false,
      xhrFields: {
        withCredentials: false
      },
      headers: {
        'Authorization': tokenCode
      },
      success: function(data) {
        console.log('AJAX API SUCCESS - PROYECTO SELECCIONADO ' +  arduino_ID);
        //Se hara un return con el JSON obtenido en la API
        //console.log(data);
        dataArduinosCallBack(data);
      },
      error: function() {
        console.log('Hubo un problema, solucionalo...!');
      }
    });
  }


  function dataArduinosCallBack( data ){
    console.log("Llego la información ARDUINO");
    console.log(data);
    console.log(actualArduino);
    //actualArduino = data.id; //ID del arduino seleccionado

    $('#my_arduinos').html(" ");

    var rowData = " ";
    rowData += '<tr><td>' + data.name + '</td><td><button id="activar_ard_'+actualArduino+'" type="button" class="btn btn-info">Activo</button> </td></tr>';

    $('#my_arduinos').html(rowData);

    for(var i=0 ; i < data.sensors.length; i++){
      //$('#my_arduinos').append(data.sensors[i] + '<br/>');
      //$('#my_arduinos').append('<div id=ard_'+data.id+ '_sens_'+ i + '></div>');
      //$('#my_arduinos').append('----------------------------<br/>' );


      getSensorsFromAPI(data.sensors[i], actualArduino, i);
    }
  }

    function getSensorsFromAPI(sensor_ID, arduinoID, sensID){

      var passData_arduinoID  = arduinoID;
      var passData_sensID     = sensor_ID;

      console.log(urlApiBase + arduinosApi+ actualArduino +'/'+'sensors/'+ sensor_ID + '/data/');

      //Peticion AJAX de los datos
      var allData;
      $.ajax({
        url: urlApiBase + arduinosApi +'sensors/'+ sensor_ID + '/data/' ,
        type: 'GET',
        contentType: 'json/application',
        dataType: 'json',
        processData: false,
        xhrFields: {
          withCredentials: false
        },
        headers: {
          'Authorization': tokenCode
        },
        success: function(data) {
          //console.log('AJAX API SUCCESS! SENSORS');
          //Se hara un return con el JSON obtenido en la API
          console.log(data);
          dataSensorsCallBack(data,passData_arduinoID,passData_sensID);
        },
        error: function() {
          console.log('Hubo un problema, solucionalo...!');
        }
      });
    }


    function dataSensorsCallBack( data, arduinoID, sensID ){
      //$('#ard_'+arduinoID+'_sens_'+sensID).append('holo');
      //console.log(data);
      var passData_arduinoID  = arduinoID;
      var passData_sensID     = sensID;

      //console.log("Llego la información sensorrrrr" + passData_sensID );
      //console.log(data);

      createGraph(data,passData_arduinoID,passData_sensID);
    }

    function createGraph(data, arduinoID, sensID){
      _sensors_data = data;

      var sensor_data_chart = [];
      var sensor_date_chart = [];

      var dygraphs_data = [];

      for (var i = 0; i < _sensors_data.length; i++) {
        sensor_data_chart.push(_sensors_data[i]['data']);

        var d = new Date(_sensors_data[i]['created_at']);
        var d_days = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
        var d_time = completeTimeFormat(d.getHours(), d.getMinutes(), d.getSeconds());
        sensor_date_chart.push(d_time);
        dygraphs_data.push([d, _sensors_data[i]['data'], "100", "250"]);
      }

      //var graph_id = 'tab_'+arduinoID+'_sens_'+sensID;
      var graph_id = 'tab_'+sensID;
      //console.log(graph_id);
      //console.log(g);

      g = new Dygraph(document.getElementById(graph_id), dygraphs_data, {
        drawPoints: true,
        showRoller: true,
        valueRange: [ 0, 300 ],
        height: 400,
        width: 900,
        highlightSeriesBackgroundAlpha: 0.8,
        fillGraph: true,
        includeZero: true,
        strokeWidth: 3,
        //showRangeSelector: true,
        labels: ['Tiempo', 'Temperatura', 'Min', 'Max']
      });

    }


    function completeTimeFormat(hours, minutes, seconds) {
      if (hours < 10) {
        hours = "0" + hours;
      }
      if (minutes < 10) {
        minutes = "0" + minutes;
      }
      if (seconds < 10) {
        seconds = "0" + seconds;
      }
      return hours + ':' + minutes + ':' + seconds;
    }

  </script>

{% endblock content_js %}
